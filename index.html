<!DOCTYPE html>
<html lang="en-US">
<head>
    <title>gamesinclass</title>
    <meta name="keywords" content="games site, games" />
    <meta property="og:title" content="GamesInClass" />
    <meta property="og:site_name" content="GamesInClass" />
    <meta property="og:description" content="Educational games platform" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <meta name="description" content="Educational games platform" />
    <meta name="author" content="Cedric" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="/favicon.ico" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <style>
        @font-face {
            font-family: 'MinecraftFont';
            src: url('/minecraft_font.woff') format('woff');
            font-display: swap;
        }

        :root {
            --background-dark: #0e0e0e;
            --text-color: #ffffff;
            --shadow-dark: rgba(0, 0, 0, 0.5);
            --shadow-light: rgba(255, 255, 255, 0.1);
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        body {
            background: var(--background-dark);
            color: var(--text-color);
            font-family: 'MinecraftFont', system-ui, -apple-system, sans-serif;
            text-align: center;
            margin: 0;
            min-height: 100vh;
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;     /* Firefox */
        }

        body::-webkit-scrollbar {
            display: none;            /* Chrome, Safari and Opera */
        }

        #pipes-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }

        .game-link {
            width: 300px;
            text-decoration: none;
            display: inline-block;
            border-radius: 30px;
            transition: transform 0.3s ease;
        }

        .game-tile {
            background-color: rgba(14, 14, 14, 0.5); /* Changed from var(--background-dark) to semi-transparent */
            border-radius: 30px;
            padding: 1.25rem;
            box-shadow: 6px 6px 12px var(--shadow-dark);
            transition: all 0.3s ease;
            position: relative;
            z-index: 1;
        }

        .game-tile::before {
            display: none; /* Remove the glow effect */
        }

        .game-tile:hover {
            box-shadow: 8px 8px 16px var(--shadow-dark);
            transform: translateY(-4px);
        }

        .game-icon {
            border-radius: 30px;
            width: 100%;
            height: auto;
            object-fit: contain;
        }

        .game-title {
            font-size: 1.375rem;
            font-weight: bold;
            color: var(--text-color);
            margin: 0.625rem 0 0;
        }

        .flex-container {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            justify-content: center;
            padding: 1rem;
        }

        .loader {
            border: 16px solid #f3f3f3;
            border-top: 16px solid #3498db;
            border-radius: 50%;
            width: 120px;
            height: 120px;
            margin: 1rem auto;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes colorChange {
            0% { color: #ff0000; }
            20% { color: #ff7f00; }
            40% { color: #ffff00; }
            60% { color: #00ff00; }
            80% { color: #0000ff; }
            100% { color: #ff0000; }
        }

        .rainbow-text {
            text-shadow: 0 0 5px currentColor, 0 0 10px currentColor;
            animation: colorChange 10s infinite;
            -webkit-text-fill-color: initial !important;
            background: none !important;
        }

        .title-section {
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin-bottom: 2rem;
        }

        h1 {
            font-size: 3em;
            margin: 0;
            animation: float 6s ease-in-out infinite, colorChange 10s infinite;
            -webkit-text-fill-color: initial !important;
            background: none !important;
            font-family: var(--font-minecraft);
        }

        #subtitle {
            padding: 1rem;
            border: none;
            border-radius: 30px;
            background: var(--background-dark);
            color: var(--text-color);
            font-size: 1.1em;
            font-family: var(--font-minecraft);
            margin-top: 1rem;
        }

        .games-section {
            min-height: 100vh;
            padding-top: 2rem;
            opacity: 0;
            transition: opacity 0.5s ease;
            pointer-events: none;
        }

        .games-section.visible {
            opacity: 1;
            pointer-events: all;
        }

        #back-to-top {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--background-dark);
            color: var(--text-color);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
        }

        #back-to-top.visible {
            opacity: 1;
        }

        #cursorGlow {
            position: fixed;
            width: 120px;
            height: 120px;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.05) 10%, transparent 70%);
            pointer-events: none;
            transform: translate(-50%, -50%);
            z-index: 9999;
        }

        #specialImage {
            max-width: 300px;  /* Increased from 200px to allow for different aspect ratios */
            max-height: 300px; /* Increased from 200px to allow for different aspect ratios */
            width: auto;       /* Remove fixed width */
            height: auto;      /* Remove fixed height */
            object-fit: contain; /* Changed from 'cover' to 'contain' to preserve aspect ratio */
            border-radius: 12px;
            display: block;
            position: relative;
            z-index: 1;
            margin-top: 2rem;
            /* Remove float animation from base styles */
            backface-visibility: hidden; /* Prevent ghosting */
            transform-style: preserve-3d; /* Help with ghosting */
            will-change: transform; /* Optimize animations */
        }

        @keyframes glowPulse {
            0%, 50%, 100% {
                filter: brightness(1.1);
            }
        }

        @keyframes float {
            0% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-10px);
            }
            100% {
                transform: translateY(0);
            }
        }

        .image-glow {
            animation: float 6s ease-in-out infinite !important;
        }

        /* Scroll indicator arrow */
        .scroll-indicator {
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 2rem;
            color: var(--text-color);
            animation: bounce 2s infinite;
            cursor: pointer;
            opacity: 0.8;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateX(-50%) translateY(0);
            }
            40% {
                transform: translateX(-50%) translateY(-20px);
            }
            60% {
                transform: translateX(-50%) translateY(-10px);
            }
        }

        .scroll-indicator.hidden {
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        /* Mobile Optimizations */
        @media (max-width: 768px) {
            h1 {
                font-size: 2em;
                padding: 0 1rem;
            }

            #subtitle {
                font-size: 1em;
                padding: 0.75rem;
                margin: 0.5rem 1rem;
            }

            .game-link {
                width: 100%;
                max-width: 300px;
                margin: 0.5rem;
            }

            .game-tile {
                padding: 0.75rem;
            }

            .game-title {
                font-size: 1.125rem;
            }

            #specialImage {
                max-width: 80%;
                margin: 1rem auto;
            }

            .flex-container {
                padding: 0.5rem;
                gap: 0.5rem;
            }

            #back-to-top {
                bottom: 10px;
                right: 10px;
                width: 40px;
                height: 40px;
            }

            .title-section {
                height: 90vh;
            }
        }

        /* Small mobile devices */
        @media (max-width: 480px) {
            h1 {
                font-size: 1.75em;
            }

            .loader {
                width: 80px;
                height: 80px;
                border-width: 12px;
            }
        }

        /* Handle orientation changes */
        @media (max-height: 500px) and (orientation: landscape) {
            .title-section {
                height: auto;
                padding: 2rem 0;
            }

            #specialImage {
                max-height: 150px;
            }
        }

        /* Improve touch targets */
        @media (hover: none) {
            .game-tile {
                padding: 1rem;
            }

            #back-to-top {
                padding: 12px;
            }
        }

        #clock {
            min-width: 0;
            position: fixed;
            left: 50%;
            transform: translateX(-50%);
            top: 20px;
            background: rgba(0, 0, 0, 0.5);
            color: var(--text-color);
            padding: 8px 16px;
            border-radius: 15px;
            font-size: clamp(0.8rem, 2.2vw, 1.1rem);
            line-height: 1;
            z-index: 1000;
            backdrop-filter: blur(5px);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            white-space: nowrap;
            max-width: 95vw;
            width: auto;
        }

        #clock > * {
            display: flex;
            align-items: center;
            gap: 6px;
            line-height: 1;
            font-size: 1em;
            border-left: 1px solid rgba(255, 255, 255, 0.2);
            padding-left: 12px;
            margin: 0;
        }

        #clock > *:first-child {
            border-left: none;
            padding-left: 0;
        }

        #clock i {
            font-size: 0.9em;
            padding: 0;
            border: none;
        }

        #weather-info,
        #spotify-info {
            border-left: 1px solid rgba(255, 255, 255, 0.2);
            padding-left: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        #spotify-info img {
            width: 1.2em;
            height: 1.2em;
        }

        @media (max-width: 768px) {
            #clock {
                padding: 6px 12px;
                gap: 8px;
                font-size: clamp(0.75rem, 2vw, 0.9rem);
            }

            #clock > * {
                padding-left: 8px;
                gap: 4px;
            }
        }

        @media (max-width: 480px) {
            #clock {
                padding: 4px 10px;
                gap: 6px;
            }

            #clock > * {
                padding-left: 6px;
            }
        }

        .settings-popup {
            position: fixed;
            top: 70px;
            right: 20px;
            background: rgba(14, 14, 14, 0.95);
            border-radius: 15px;
            padding: 15px;
            z-index: 999;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            min-width: 250px;
            max-width: 90vw;
            max-height: 80vh;
            overflow-y: auto;
            transform: translateY(-20px);
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s ease;
        }

        .settings-popup.visible {
            transform: translateY(0);
            opacity: 1;
            pointer-events: all;
        }

        .settings-popup h3 {
            margin: 0 0 15px 0;
            font-size: 1.1em;
            color: var(--text-color);
        }

        .setting-item {
            margin: 10px 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .setting-item label {
            font-size: 0.85em;
            color: var(--text-color);
            flex-shrink: 0;
        }

        .setting-item input[type="range"] {
            width: 100px;
        }

        .setting-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
        }

        .setting-item input[type="text"] {
            width: 110px;
            padding: 3px 6px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            background: rgba(0, 0, 0, 0.2);
            color: var(--text-color);
            font-size: 0.85em;
        }

        .setting-note {
            font-size: 0.75em;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 2px;
            text-align: right;
        }

        #spotify-info {
            font-size: 0.9em;
            opacity: 0.9;
            padding-left: 8px;
            border-left: 1px solid rgba(255, 255, 255, 0.2);
            display: none;
            align-items: center;
            gap: 8px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        #spotify-info.visible {
            display: flex;
        }

        #spotify-info img {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            object-fit: cover;
        }

        .spotify-connect-btn {
            background: #1DB954;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s;
        }

        .spotify-connect-btn:hover {
            background: #1ed760;
        }

        @media (max-width: 768px) {
            #spotify-info {
                max-width: 120px;
                white-space: nowrap;
            }

            .settings-popup {
                padding: 12px;
                max-height: 70vh;
            }

            .setting-item {
                margin: 8px 0;
            }
        }

        .tutorial-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.95);
            background: rgba(14, 14, 14, 0.98);
            border-radius: 15px;
            padding: 25px;
            max-width: 400px;
            width: 90%;
            z-index: 1001;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s ease;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
        }

        .tutorial-popup.visible {
            opacity: 1;
            pointer-events: all;
            transform: translate(-50%, -50%) scale(1);
        }

        .tutorial-popup h3 {
            color: #1DB954;
            margin: 0 0 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tutorial-content {
            margin: 15px 0;
            line-height: 1.5;
        }

        .tutorial-steps {
            margin: 15px 0;
            padding-left: 20px;
        }

        .tutorial-steps li {
            margin: 10px 0;
            text-align: left;
        }

        .warning-text {
            color: #ff6b6b;
            font-weight: bold;
            padding: 10px;
            border: 1px solid #ff6b6b;
            border-radius: 8px;
            margin: 15px 0;
            text-align: left;
        }

        .tutorial-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .tutorial-button {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .tutorial-button.primary {
            background: #1DB954;
            color: white;
        }

        .tutorial-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(3px);
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .tutorial-overlay.visible {
            opacity: 1;
            pointer-events: all;
        }

        .info-icon {
            cursor: help;
            color: #1DB954;
            margin-left: 5px;
        }

        .song-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            text-align: center;
            border-radius: 0 0 12px 12px;
            backdrop-filter: blur(5px);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        #specialImage:hover .song-overlay {
            opacity: 1;
        }

        #spotify-song-title {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 30px;
            background: rgba(0, 0, 0, 0.5);
            color: var(--text-color);
            font-size: 1em;
            font-family: var(--font-minecraft);
            margin-top: 0.5rem;
            backdrop-filter: blur(5px);
            display: none;
            position: relative;
            padding-bottom: 12px;
        }

        #spotify-song-title.visible {
            display: block;
        }

        .progress-bar {
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            overflow: hidden;
            position: relative;
            margin-top: 8px;
        }

        .progress-bar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: #1DB954;
            transition: width 0.1s linear;
        }

        .danger-zone {
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(255, 0, 0, 0.3);
        }

        .danger-zone h4 {
            color: #ff6b6b;
            margin-bottom: 1rem;
        }

        .reset-button {
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s;
            width: 100%;
            margin-top: 0.5rem;
        }

        .reset-button:hover {
            background: #ff8787;
        }

        #weather-info {
            font-size: 0.9em;
            opacity: 0.9;
            padding-left: 8px;
            border-left: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #weather-info i {
            font-size: 14px;
        }

        @media (max-width: 768px) {
            #weather-info {
                display: none;
            }
        }

        .setting-category {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .setting-category h4 {
            margin: 0 0 10px 0;
            font-size: 0.95em;
            color: var(--text-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        #spotify-info {
            /* ...existing styles... */
            flex-direction: column;
            gap: 4px;
        }

        .spotify-progress {
            width: 100%;
            height: 2px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 1px;
            overflow: hidden;
            margin-top: 2px;
        }

        .spotify-progress-bar {
            height: 100%;
            background: #1DB954;
            width: 0;
            transition: width 0.1s linear;
        }

        #spotify-song-title {
            /* ...existing styles... */
            position: relative;
            padding-bottom: 12px;
        }

        #spotify-song-title .spotify-progress {
            position: absolute;
            bottom: 4px;
            left: 0;
            width: 100%;
        }
    </style>
</head>
<body>
    <canvas id="pipes-canvas"></canvas>
    <div id="cursorGlow" aria-hidden="true"></div>
    <div id="clock">
        <span id="time"></span>
        <span id="day-text"></span>
        <span id="battery-level"></span>
        <span id="weather-info">
            <i class="bi bi-thermometer-half"></i>
            <span id="weather-temp"></span>
        </span>
        <i id="os-icon"></i>
        <i id="browser-icon"></i>
        <div id="spotify-info">
            <div style="display: flex; align-items: center; gap: 8px; width: 100%">
                <i class="bi bi-spotify"></i>
                <span id="spotify-track"></span>
            </div>
            <div class="spotify-progress">
                <div class="spotify-progress-bar" id="spotify-toolbar-progress"></div>
            </div>
        </div>
    </div>
    
    <div class="title-section">
        <h1 class="rainbow-text">gamesinclass</h1>
        <span id="subtitle" class="neumorphic rainbow-text">Loading...</span>
        <span id="spotify-song-title">
            <span id="song-title-text"></span>
        </span>
        <div id="song-progress-bar" class="progress-bar" style="display: none;"></div>
        <img id="specialImage" src="" alt="Special Image" style="display: none;" />
        <div id="special-image-progress-bar" class="progress-bar" style="display: none;"></div>
        <div class="scroll-indicator">\/</div>
    </div>

    <div class="games-section">
        <div id="loader" class="loader" role="status" aria-label="Loading games"></div>
        <div id="game-container" class="flex-container"></div>
    </div>

    <button id="back-to-top" aria-label="Back to top">↑</button>

    <div class="settings-popup" id="settings">
        <h3>Settings</h3>
        <div class="setting-item">
            <label for="pipeCount">Background Pipes</label>
            <input type="range" id="pipeCount" min="5" max="30" value="15">
        </div>
        <div class="setting-item">
            <label>24-hour Time</label>
            <input type="checkbox" id="time24h" checked>
        </div>
        <div class="setting-category">
            <h4>Spotify Integration <i class="bi bi-question-circle info-icon" id="showSpotifyTutorial"></i></h4>
            <div class="setting-item">
                <label>Client ID</label>
                <input type="text" id="spotifyClientId" placeholder="Enter Client ID">
            </div>
            <div class="setting-note">
                Get your Client ID from the <a href="https://developers.spotify.com/dashboard" target="_blank" style="color: #1DB954">Spotify Dashboard</a>
            </div>
            <div class="setting-item">
                <label>Connect Spotify</label>
                <button class="spotify-connect-btn" id="spotifyConnect" disabled>
                    Connect
                </button>
            </div>
            <div class="setting-item">
                <label>Replace Special Image with Album</label>
                <input type="checkbox" id="replaceWithAlbum">
            </div>
        </div>
        <div class="setting-category">
            <h4>Weather</h4>
            <div class="setting-item">
                <label>OpenWeather API Key</label>
                <input type="text" id="weatherApiKey" placeholder="Enter API key">
            </div>
            <div class="setting-item">
                <label>Latitude</label>
                <input type="number" id="weatherLat" placeholder="44.744155" step="0.000001">
            </div>
            <div class="setting-item">
                <label>Longitude</label>
                <input type="number" id="weatherLon" placeholder="-79.885203" step="0.000001">
            </div>
            <div class="setting-item">
                <label>Use Device Location</label>
                <input type="checkbox" id="useDeviceLocation" checked>
            </div>
            <div class="setting-note">
                Get your API key from <a href="https://openweathermap.org/api" target="_blank">OpenWeatherMap</a>
            </div>
        </div>
        <div class="danger-zone">
            <h4>Danger Zone</h4>
            <div class="setting-item">
                <label>Reset All Settings</label>
                <button class="reset-button" id="resetSettings">Reset</button>
            </div>
            <div class="setting-note">
                This will clear all saved settings and reload the page
            </div>
        </div>
    </div>

    <div class="tutorial-overlay" id="spotifyTutorialOverlay"></div>
    <div class="tutorial-popup" id="spotifyTutorial">
        <h3><i class="bi bi-spotify"></i> Spotify Integration Tutorial</h3>
        <div class="warning-text">
            <i class="bi bi-exclamation-triangle"></i> WARNING: This feature is quite experimental and may not work as expected. Use at your own risk.
        </div>
        <div class="tutorial-content">
            To connect your Spotify account, follow these steps:
            <ol class="tutorial-steps">
                <li>Go to the <a href="https://developers.spotify.com/dashboard" target="_blank" style="color: #1DB954">Spotify Dashboard</a></li>
                <li>Create a new app (name it whatever you want)</li>
                <li>Copy the Client ID from your app</li>
                <li>Add this site's URL to the Redirect URIs in your app settings</li>
                <li>Paste the Client ID in the settings here</li>
                <li>Click Connect and authorize the app</li>
            </ol>
        </div>
        <div class="tutorial-buttons">
            <button class="tutorial-button primary" id="closeTutorial">Close</button>
        </div>
    </div>

    <script>
        // Add the Pipe class and animation code from index.html
        class Pipe {
            constructor(canvas, ctx) {
                this.canvas = canvas;
                this.ctx = ctx;
                this.opacity = 0; // Add opacity property
                this.pulsePhase = Math.random() * Math.PI * 2; // Add phase for pulsing
                this.reset();
            }

            reset() {
                this.x = Math.random() * this.canvas.width;
                this.y = Math.random() * this.canvas.height;
                this.z = 0;
                this.direction = Math.floor(Math.random() * 6);
                this.color = `hsl(${Math.random() * 360}, 50%, 50%)`;
                this.length = 0;
                this.maxLength = Math.random() * 50 + 50;
                this.baseSize = Math.random() * 10 + 5; // Store base size for pulsing
                this.size = this.baseSize;
                this.opacity = 0; // Reset opacity
                this.fading = false; // Track if pipe is fading out
            }

            update() {
                const speed = 2;
                const defaultOpacity = 0.4; // Increased from 0.2
                
                // Add music reactivity when Spotify is playing
                if (window.musicData && window.musicData.isPlaying) {
                    // Enhanced beat reaction
                    const bpmScale = (window.musicData.bpm / 120); 
                    const intensityMultiplier = 1.5; // Increased effect intensity
                    const beatTime = Date.now() * 0.001 * bpmScale * Math.PI;
                    
                    // Stronger pulse effect
                    const pulseAmount = Math.sin(this.pulsePhase + beatTime) * 0.5 + 1;
                    this.size = this.baseSize * pulseAmount * intensityMultiplier;
                    
                    // Color pulsing with beat
                    if (window.musicData.dominantColor) {
                        const rgb = window.musicData.dominantColor.match(/\d+/g).map(Number);
                        const pulseFactor = (pulseAmount - 0.5) * 0.3;
                        this.color = `rgb(
                            ${Math.min(255, rgb[0] * (1 + pulseFactor))},
                            ${Math.min(255, rgb[1] * (1 + pulseFactor))},
                            ${Math.min(255, rgb[2] * (1 + pulseFactor))})`;
                    }

                    // Enhanced opacity based on energy
                    const maxOpacity = 0.4 + (window.musicData.energy * 0.6); // Increased from 0.3
                    if (!this.fading && this.opacity < maxOpacity) {
                        this.opacity += 0.02; // Faster fade in
                    }
                } else {
                    this.size = this.baseSize;
                    // Maintain higher default opacity when no music is playing
                    if (!this.fading && this.opacity < defaultOpacity) {
                        this.opacity += 0.01;
                    }
                }

                switch(this.direction) {
                    case 0: this.x += speed; break;
                    case 1: this.x -= speed; break;
                    case 2: this.y += speed; break;
                    case 3: this.y -= speed; break;
                    case 4: this.z += speed; break;
                    case 5: this.z -= speed; break;
                }

                this.length += speed;

                // Start fading out before reset
                if (this.length > this.maxLength - 20 || 
                    this.x < 20 || this.x > this.canvas.width - 20 ||
                    this.y < 20 || this.y > this.canvas.height - 20) {
                    this.fading = true;
                    this.opacity -= 0.01;
                }

                // Only reset when fully faded
                if (this.opacity <= 0) {
                    this.reset();
                }
            }

            draw() {
                const perspective = 1000;
                const scale = perspective / (perspective + this.z);
                
                this.ctx.beginPath();
                this.ctx.strokeStyle = this.color;
                this.ctx.lineWidth = this.size * scale;
                this.ctx.lineCap = 'round';
                this.ctx.globalAlpha = this.opacity;
                
                const startX = this.x * scale;
                const startY = this.y * scale;
                let endX = startX;
                let endY = startY;

                switch(this.direction) {
                    case 0: endX = (this.x - this.length) * scale; break;
                    case 1: endX = (this.x + this.length) * scale; break;
                    case 2: endY = (this.y - this.length) * scale; break;
                    case 3: endY = (this.y + this.length) * scale; break;
                }

                this.ctx.moveTo(startX, startY);
                this.ctx.lineTo(endX, endY);
                this.ctx.stroke();
            }
        }

        const canvas = document.getElementById('pipes-canvas');
        const ctx = canvas.getContext('2d');
        const pipes = [];
        const numPipes = 15;

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }

        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        for(let i = 0; i < numPipes; i++) {
            pipes.push(new Pipe(canvas, ctx));
        }

        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = 'rgba(19, 21, 26, 0.2)'; // More transparent background
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            pipes.forEach(pipe => {
                pipe.update();
                pipe.draw();
            });

            requestAnimationFrame(animate);
        }

        animate();

        const gameContainer = document.getElementById("game-container");
        const loader = document.getElementById("loader");
        const backToTopButton = document.getElementById("back-to-top");
        const cursorGlow = document.getElementById("cursorGlow");
        let games = [];

        async function loadGames() {
            try {
                const response = await fetch("config/games.json");
                games = await response.json();
                renderGames(games);
                loader.style.display = "none";
            } catch (error) {
                console.error("Error loading games:", error);
                gameContainer.innerHTML = "<p>Error loading games. Please try again later.</p>";
                loader.style.display = "none";
            }
        }

        function renderGames(gamesToRender) {
            gameContainer.innerHTML = gamesToRender
                .map(project => `
                    <a href="${project.link}" class="game-link">
                        <div class="game-tile">
                            <img class="game-icon" src="${project.imgSrc}" 
                                 alt="${project.title}" />
                            <p class="game-title">${project.title}</p>
                        </div>
                    </a>
                `).join("");
        }

        window.addEventListener("scroll", () => {
            const scrolled = window.scrollY > 100;
            backToTopButton.classList.toggle("visible", scrolled);
        });

        document.addEventListener("mousemove", (e) => {
            requestAnimationFrame(() => {
                cursorGlow.style.left = `${e.clientX}px`;
                cursorGlow.style.top = `${e.clientY}px`;
            });
        });

        backToTopButton.addEventListener("click", () => {
            window.scrollTo({ top: 0, behavior: "smooth" });
        });

        loadGames();

        // Replace the subtitle script loading with this new code
        async function loadAndUpdateSubtitle() {
            const subtitle = document.getElementById('subtitle');
            try {
                const response = await fetch('./config/subtitles.json');  // Updated path
                const data = await response.json();
                const subtitles = data.subtitles;
                
                // Pick a random subtitle once
                const randomSubtitle = subtitles[Math.floor(Math.random() * subtitles.length)];
                subtitle.textContent = randomSubtitle;

            } catch (error) {
                console.error('Error loading subtitles:', error);
                subtitle.textContent = 'Welcome to GamesInClass!';
            }
        }

        loadAndUpdateSubtitle();

        // Add special images array at the top
        const specialImages = [
        './specialimages/maxwell.png',
            './specialimages/petah.jpg',
            './specialimages/sillyguy.png',
            './specialimages/stopposting.jpg',
            './specialimages/metro-boomin-heroes-and-villains.gif',
            './specialimages/school-bus-monster-bus.gif',
            './specialimages/bbnomoist.gif',
            './specialimages/chinese_street_cats.jpg',
            './specialimages/flightreacts_tongue.gif',
            './specialimages/gliznorp.gif',
            './specialimages/gunna_fire.gif',
            './specialimages/kai_cenat_chair.gif',
            './specialimages/markiplier_despair.gif',
            './specialimages/markiplier-punch.gif',
            './specialimages/Please_do_not_feed_the_fishes_with_your_private.jpg',
            './specialimages/shrek_humorous_reaction.gif',
            './specialimages/speed_jump.gif',
            './specialimages/spongebob_dance.gif',
            './specialimages/tweaking.gif',
            './specialimages/xqc-bounce.gif',
            './specialimages/xqc-scared.gif',
            './specialimages/i-lost-lost.gif',
            './specialimages/tenor.gif',
            './specialimages/images.jpg',
            './specialimages/eye-of-rah-dread.gif',
            './specialimages/happy-shrek.gif',
        ];

        // Replace the entire getRegionColors and setRandomSpecialImage functions with this simpler version:
        function setRandomSpecialImage() {
            if (specialImages.length > 0) {
                const randomImage = specialImages[Math.floor(Math.random() * specialImages.length)];
                const specialImage = document.getElementById('specialImage');
                
                specialImage.onerror = () => {
                    console.error('Failed to load image:', randomImage);
                    specialImage.style.display = 'none';
                };
                
                specialImage.onload = () => {
                    specialImage.classList.add('image-glow');
                    specialImage.style.display = 'block';
                };
                
                specialImage.src = randomImage;
            }
        }

        // Call setRandomSpecialImage after page loads
        setRandomSpecialImage();

        // Add scroll indicator logic
        const scrollIndicator = document.querySelector('.scroll-indicator');
        
        // Hide arrow when scrolling down
        window.addEventListener('scroll', () => {
            if (window.scrollY > 100) {
                scrollIndicator.classList.add('hidden');
            } else {
                scrollIndicator.classList.remove('hidden');
            }
        });

        // Smooth scroll when clicking the arrow
        scrollIndicator.addEventListener('click', () => {
            window.scrollTo({
                top: window.innerHeight,
                behavior: 'smooth'
            });
        });

        // Add this near the other scroll event listeners
        window.addEventListener('scroll', () => {
            const gamesSection = document.querySelector('.games-section');
            const scrollPosition = window.scrollY;
            const windowHeight = window.innerHeight;

            if (scrollPosition > windowHeight * 0.5) {
                gamesSection.classList.add('visible');
            } else {
                gamesSection.classList.remove('visible');
            }
        });

        function detectOS() {
            const platform = navigator.platform.toLowerCase();
            const userAgent = navigator.userAgent.toLowerCase();
            
            // Mobile detection
            if (/iphone|ipad|ipod/.test(userAgent)) return 'bi-apple';
            if (/android/.test(userAgent)) return 'bi-android';
            
            // Desktop detection
            if (platform.includes('win')) return 'bi-windows';
            if (platform.includes('mac')) return 'bi-apple';
            if (platform.includes('linux')) return 'bi-terminal'; // Terminal icon looks more Linux-like than Ubuntu logo
            
            return 'bi-cpu';
        }

        function detectBrowser() {
            const ua = navigator.userAgent.toLowerCase();
            
            // Check for Chromium-based browsers first
            if (ua.includes('edg/')) return 'bi-browser-edge';
            if (ua.includes('opr/') || ua.includes('opera')) return 'bi-browser-chrome'; // Opera
            if (ua.includes('brave')) return 'bi-shield'; // Brave
            if (ua.includes('vivaldi')) return 'bi-browser-chrome'; // Vivaldi
            if (ua.includes('chromium')) return 'bi-browser-chrome'; // Generic Chromium
            
            // Check for other major browsers
            if (ua.includes('firefox')) return 'bi-browser-firefox';
            if (ua.includes('safari') && !ua.includes('chrome')) return 'bi-browser-safari'; // Safari (exclude Chrome)
            if (ua.includes('chrome')) return 'bi-browser-chrome'; // Chrome last to avoid false positives
            
            // Additional browsers
            if (ua.includes('msie') || ua.includes('trident')) return 'bi-browser-edge'; // Internet Explorer
            if (ua.includes('tor')) return 'bi-shield-lock'; // Tor Browser
            if (ua.includes('seamonkey')) return 'bi-browser';
            if (ua.includes('pale moon')) return 'bi-moon'; // Pale Moon
            
            return 'bi-browser'; // Generic browser icon fallback
        }

        const defaultSettings = {
            pipeCount: 15,
            time24h: true,
            spotifyClientId: '',
            replaceWithAlbum: false,
            weatherApiKey: 'bd5e378503939ddaee76f12ad7a97608',
            weatherLat: 44.744155,
            weatherLon: -79.885203,
            useDeviceLocation: true
        };

        let settings = {
            ...defaultSettings,
            ...JSON.parse(localStorage.getItem('siteSettings') || '{}')
        };

        function saveSettings() {
            localStorage.setItem('siteSettings', JSON.stringify(settings));
        }

        function updatePipeCount(count) {
            while (pipes.length > count) {
                pipes.pop();
            }
            while (pipes.length < count) {
                pipes.push(new Pipe(canvas, ctx));
            }
        }

        function initializeSettings() {
            const settingsPopup = document.getElementById('settings');
            const clock = document.getElementById('clock');
            const spotifyControls = document.querySelectorAll('.spotify-controls i');

            // Update click handling
            clock.addEventListener('click', (e) => {
                // Don't open settings if clicking on spotify controls
                if (!e.target.closest('.spotify-controls')) {
                    settingsPopup.classList.toggle('visible');
                }
            });

            // Stop event propagation from controls
            spotifyControls.forEach(control => {
                control.addEventListener('click', (e) => {
                    e.stopPropagation();
                });
            });

            // Initialize controls with saved values
            const pipeCountSlider = document.getElementById('pipeCount');
            const time24hToggle = document.getElementById('time24h');

            pipeCountSlider.value = settings.pipeCount;
            time24hToggle.checked = settings.time24h;

            updatePipeCount(settings.pipeCount);

            document.addEventListener('click', (e) => {
                if (!settingsPopup.contains(e.target) && !clock.contains(e.target)) {
                    settingsPopup.classList.remove('visible');
                }
            });

            pipeCountSlider.addEventListener('input', (e) => {
                settings.pipeCount = parseInt(e.target.value);
                updatePipeCount(settings.pipeCount);
                saveSettings();
            });

            time24hToggle.addEventListener('change', (e) => {
                settings.time24h = e.target.checked;
                saveSettings();
            });

            const spotifyClientId = document.getElementById('spotifyClientId');
            const spotifyConnectBtn = document.getElementById('spotifyConnect');

            // Initialize Spotify client ID
            spotifyClientId.value = settings.spotifyClientId || '';
            spotifyConnectBtn.disabled = !settings.spotifyClientId;

            // Add client ID input listener
            spotifyClientId.addEventListener('input', (e) => {
                settings.spotifyClientId = e.target.value.trim();
                spotifyConnectBtn.disabled = !settings.spotifyClientId;
                saveSettings();
                
                // Disconnect if client ID changes
                if (spotifyManager.accessToken) {
                    spotifyManager.disconnect();
                    spotifyConnectBtn.textContent = 'Connect';
                }
            });

            // Update connect button initialization
            spotifyConnectBtn.addEventListener('click', () => {
                if (!settings.spotifyClientId) return;
                
                if (spotifyManager.accessToken) {
                    spotifyManager.disconnect();
                    spotifyConnectBtn.textContent = 'Connect';
                } else {
                    spotifyManager.authorize();
                    spotifyConnectBtn.textContent = 'Disconnect';
                }
            });

            if (spotifyManager.accessToken) {
                spotifyConnectBtn.textContent = 'Disconnect';
            }

            const tutorialPopup = document.getElementById('spotifyTutorial');
            const tutorialOverlay = document.getElementById('spotifyTutorialOverlay');
            const showTutorialBtn = document.getElementById('showSpotifyTutorial');
            const closeTutorialBtn = document.getElementById('closeTutorial');

            function showTutorial(e) {
                e.stopPropagation(); // Prevent settings from closing
                tutorialPopup.classList.add('visible');
                tutorialOverlay.classList.add('visible');
            }

            function hideTutorial() {
                tutorialPopup.classList.remove('visible');
                tutorialOverlay.classList.remove('visible');
            }

            // Show tutorial only when info icon is clicked
            showTutorialBtn.addEventListener('click', showTutorial);
            closeTutorialBtn.addEventListener('click', hideTutorial);
            tutorialOverlay.addEventListener('click', hideTutorial);

            // Close tutorial when clicking outside
            document.addEventListener('click', (e) => {
                if (!tutorialPopup.contains(e.target) && !showTutorialBtn.contains(e.target)) {
                    hideTutorial();
                }
            });

            const replaceWithAlbumToggle = document.getElementById('replaceWithAlbum');

            replaceWithAlbumToggle.checked = settings.replaceWithAlbum;

            replaceWithAlbumToggle.addEventListener('change', (e) => {
                settings.replaceWithAlbum = e.target.checked;
                saveSettings();
                
                if (!e.target.checked) {
                    // Reload page when option is turned off
                    window.location.reload();
                } else {
                    spotifyManager.updatePlaybackInfo();
                }
            });

            // Add reset functionality
            const resetButton = document.getElementById('resetSettings');
            resetButton.addEventListener('click', () => {
                if (confirm('Are you sure you want to reset all settings? This will clear all saved data and reload the page.')) {
                    localStorage.clear();
                    window.location.reload();
                }
            });

            const weatherApiKey = document.getElementById('weatherApiKey');
            weatherApiKey.value = settings.weatherApiKey || '';

            weatherApiKey.addEventListener('input', (e) => {
                settings.weatherApiKey = e.target.value.trim();
                saveSettings();
                weatherManager.updateWeather();
            });

            const weatherLat = document.getElementById('weatherLat');
            const weatherLon = document.getElementById('weatherLon');
            const useDeviceLocation = document.getElementById('useDeviceLocation');

            weatherLat.value = settings.weatherLat;
            weatherLon.value = settings.weatherLon;
            useDeviceLocation.checked = settings.useDeviceLocation;

            weatherLat.addEventListener('input', (e) => {
                settings.weatherLat = parseFloat(e.target.value);
                saveSettings();
                weatherManager.updateWeather();
            });

            weatherLon.addEventListener('input', (e) => {
                settings.weatherLon = parseFloat(e.target.value);
                saveSettings();
                weatherManager.updateWeather();
            });

            useDeviceLocation.addEventListener('change', (e) => {
                settings.useDeviceLocation = e.target.checked;
                weatherLat.disabled = e.target.checked;
                weatherLon.disabled = e.target.checked;
                saveSettings();
                weatherManager.updateWeather();
            });

            // Set initial disabled state of coordinate inputs
            weatherLat.disabled = settings.useDeviceLocation;
            weatherLon.disabled = settings.useDeviceLocation;

            // Start weather updates
            if (settings.weatherApiKey) {
                weatherManager.updateWeather();
                setInterval(() => weatherManager.updateWeather(), 60000); // Check every minute
            }
        }

        function updateClock() {
            const timeSpan = document.getElementById('time');
            const dayText = document.getElementById('day-text');
            const osIcon = document.getElementById('os-icon');
            const browserIcon = document.getElementById('browser-icon');
            const batteryLevel = document.getElementById('battery-level');
            
            const now = new Date();
            const hours = settings.time24h ? 
                now.getHours().toString().padStart(2, '0') :
                (now.getHours() % 12 || 12).toString();
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const seconds = now.getSeconds().toString().padStart(2, '0');
            
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const dayName = days[now.getDay()];
            const dayNum = now.getDate();
            
            timeSpan.textContent = `${hours}:${minutes}:${seconds}`;
            dayText.textContent = `${dayName} ${dayNum}`;
            
            if (!osIcon.className) {
                osIcon.className = detectOS();
            }
            if (!browserIcon.className) {
                browserIcon.className = detectBrowser();
            }

            // Battery check
            if ('getBattery' in navigator || 'battery' in navigator) {
                const batteryPromise = 'getBattery' in navigator ?
                    navigator.getBattery() :
                    Promise.resolve(navigator.battery);

                batteryPromise.then(battery => {
                    const level = Math.round(battery.level * 100);
                    batteryLevel.textContent = `${level}%`;
                }).catch(() => {
                    batteryLevel.style.display = 'none';
                });
            } else {
                batteryLevel.style.display = 'none';
            }
        }

        // Remove the network status event listeners
        setInterval(updateClock, 1000);
        updateClock();

        document.addEventListener('DOMContentLoaded', initializeSettings);

        // Spotify configuration
        const SPOTIFY_REDIRECT_URI = window.location.origin + window.location.pathname;
        const SPOTIFY_SCOPES = 'user-read-playback-state';

        class SpotifyManager {
            constructor() {
                this.accessToken = null;
                this.refreshTimer = null;
                this.isProduction = window.location.hostname === 'gamesinclass.pages.dev';
                
                // Check for stored token and expiry
                const storedToken = localStorage.getItem('spotify_access_token');
                const tokenExpiry = localStorage.getItem('spotify_token_expiry');
                
                if (storedToken && tokenExpiry && Date.now() < parseInt(tokenExpiry)) {
                    this.accessToken = storedToken;
                } else {
                    // Clear invalid/expired tokens
                    localStorage.removeItem('spotify_access_token');
                    localStorage.removeItem('spotify_token_expiry');
                }
                
                this.autoConnect();
                window.musicData = {
                    isPlaying: false,
                    bpm: 120,
                    energy: 0.5,
                    dominantColor: null
                };
            }

            async autoConnect() {
                if (!this.isProduction) {
                    console.log('Spotify auto-connect disabled on non-production domain');
                    return;
                }

                // Check for auth callback first
                if (window.location.hash) {
                    this.checkLoginCallback();
                    return;
                }

                // Then check for valid token
                if (this.accessToken) {
                    this.startPlaybackCheck();
                    return;
                }

                // Finally, try to connect if we have a client ID
                if (settings.spotifyClientId) {
                    this.authorize();
                }
            }

            getClientId() {
                return settings.spotifyClientId;
            }

            authorize() {
                const clientId = this.getClientId();
                if (!clientId) return;
                
                const state = Math.random().toString(36).substring(7);
                localStorage.setItem('spotify_auth_state', state);
                
                const authUrl = `https://accounts.spotify.com/authorize?` +
                    `client_id=${clientId}` +
                    `&response_type=token` +
                    `&redirect_uri=${encodeURIComponent(SPOTIFY_REDIRECT_URI)}` +
                    `&state=${state}` +
                    `&scope=${encodeURIComponent(SPOTIFY_SCOPES)}`;
                
                window.location.href = authUrl;
            }

            checkLoginCallback() {
                if (!window.location.hash) return;

                const params = new URLSearchParams(window.location.hash.substring(1));
                const state = params.get('state');
                const storedState = localStorage.getItem('spotify_auth_state');
                
                // Clear the stored state
                localStorage.removeItem('spotify_auth_state');

                // Validate state to prevent CSRF
                if (state === null || state !== storedState) {
                    console.error('Invalid auth state');
                    return;
                }

                const accessToken = params.get('access_token');
                const expiresIn = params.get('expires_in');

                if (accessToken && expiresIn) {
                    this.accessToken = accessToken;
                    const expiryTime = Date.now() + (parseInt(expiresIn) * 1000);
                    
                    localStorage.setItem('spotify_access_token', accessToken);
                    localStorage.setItem('spotify_token_expiry', expiryTime.toString());
                    
                    // Clear the URL hash without reloading
                    history.replaceState(null, null, ' ');
                    
                    this.startPlaybackCheck();
                }
            }

            async getCurrentPlayback() {
                if (!this.accessToken) return null;
                
                try {
                    const response = await fetch('https://api.spotify.com/v1/me/player', {
                        headers: {
                            'Authorization': `Bearer ${this.accessToken}`
                        }
                    });

                    if (response.status === 401) {
                        // Token expired
                        this.accessToken = null;
                        localStorage.removeItem('spotify_access_token');
                        return null;
                    }

                    if (response.status === 204) {
                        // No active playback
                        return null;
                    }

                    const data = await response.json();
                    return data;
                } catch (error) {
                    console.error('Spotify API error:', error);
                    return null;
                }
            }

            startPlaybackCheck() {
                this.updatePlaybackInfo();
                this.refreshTimer = setInterval(() => this.updatePlaybackInfo(), 5000);
            }

            async updatePlaybackInfo() {
                const playback = await this.getCurrentPlayback();
                const spotifyInfo = document.getElementById('spotify-info');
                const spotifyTrack = document.getElementById('spotify-track');
                const specialImage = document.getElementById('specialImage');
                const spotifyTitle = document.getElementById('spotify-song-title');
                const songTitleText = document.getElementById('song-title-text');
                const toolbarProgress = document.getElementById('spotify-toolbar-progress');
                
                if (playback && playback.item) {
                    // Get audio features
                    const features = await this.getTrackFeatures(playback.item.id);
                    const albumArt = playback.item.album.images[0]?.url;
                    
                    // Update music data for pipes
                    window.musicData = {
                        isPlaying: playback.is_playing,
                        bpm: features ? features.tempo : 120,
                        energy: features ? features.energy : 0.5,
                        dominantColor: albumArt ? await getAverageColor(albumArt) : null
                    };

                    spotifyInfo.classList.add('visible');
                    const songInfo = `${playback.item.name} - ${playback.item.artists[0].name}`;
                    const progressPercent = (playback.progress_ms / playback.item.duration_ms) * 100;

                    // Update only toolbar progress
                    toolbarProgress.style.width = `${progressPercent}%`;
                    
                    if (isInGamesSection || !settings.replaceWithAlbum) {
                        spotifyTrack.textContent = songInfo;
                        spotifyTitle.classList.remove('visible');
                        
                        // Show album art in toolbar
                        const albumArt = playback.item.album.images[playback.item.album.images.length - 1]?.url;
                        const spotifyIcon = spotifyInfo.querySelector('i');
                        const existingImg = spotifyInfo.querySelector('img');

                        if (spotifyIcon) spotifyIcon.style.display = 'none';
                        if (existingImg) {
                            existingImg.src = albumArt;
                        } else if (albumArt) {
                            const img = document.createElement('img');
                            img.src = albumArt;
                            img.alt = 'Album Art';
                            spotifyInfo.insertBefore(img, spotifyTrack);
                        }
                    } else {
                        spotifyTrack.textContent = "Playing";
                        songTitleText.textContent = songInfo;
                        spotifyTitle.classList.add('visible');
                        
                        // Remove album art from toolbar
                        const existingImg = spotifyInfo.querySelector('img');
                        if (existingImg) existingImg.remove();
                        const spotifyIcon = spotifyInfo.querySelector('i');
                        if (spotifyIcon) spotifyIcon.style.display = '';

                        // Update special image if using album replacement
                        if (playback.item.album.images[0]?.url) {
                            specialImage.src = playback.item.album.images[0].url;
                            specialImage.style.display = 'block';
                        }
                    }

                    const progressBar = settings.replaceWithAlbum ? 
                        document.getElementById('special-image-progress-bar') : 
                        document.getElementById('song-progress-bar');
                    progressBar.style.display = 'block';
                    progressBar.querySelector('::before').style.width = `${progressPercent}%`;
                } else {
                    document.getElementById('song-progress-bar').style.display = 'none';
                    document.getElementById('special-image-progress-bar').style.display = 'none';
                    window.musicData = {
                        isPlaying: false,
                        bpm: 120,
                        energy: 0.5,
                        dominantColor: null
                    };
                }
            }

            async getTrackFeatures(trackId) {
                if (!this.accessToken) return null;
                
                try {
                    const response = await fetch(`https://api.spotify.com/v1/audio-features/${trackId}`, {
                        headers: {
                            'Authorization': `Bearer ${this.accessToken}`
                        }
                    });

                    if (!response.ok) return null;
                    return await response.json();
                } catch (error) {
                    console.error('Error getting track features:', error);
                    return null;
                }
            }

            disconnect() {
                this.accessToken = null;
                localStorage.removeItem('spotify_access_token');
                if (this.refreshTimer) {
                    clearInterval(this.refreshTimer);
                }
                document.getElementById('spotify-info').classList.remove('visible');
                window.musicData = {
                    isPlaying: false,
                    bpm: 120,
                    energy: 0.5,
                    dominantColor: null
                };
            }
        }

        // Add this before SpotifyManager class
        async function getAverageColor(imageUrl) {
            return new Promise((resolve) => {
                const img = new Image();
                img.crossOrigin = "Anonymous";
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    
                    const data = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
                    let r = 0, g = 0, b = 0;
                    
                    for (let i = 0; i < data.length; i += 4) {
                        r += data[i];
                        g += data[i + 1];
                        b += data[i + 2];
                    }
                    
                    const pixels = data.length / 4;
                    const color = `rgb(${r/pixels}, ${g/pixels}, ${b/pixels})`;
                    resolve(color);
                };
                img.src = imageUrl;
            });
        }

        // Initialize Spotify integration
        const spotifyManager = new SpotifyManager();

        // Add scroll position check
        let isInGamesSection = false;

        window.addEventListener('scroll', () => {
            const gamesSection = document.querySelector('.games-section');
            const scrollPosition = window.scrollY;
            const windowHeight = window.innerHeight;
            const wasInGamesSection = isInGamesSection;

            isInGamesSection = scrollPosition > windowHeight * 0.5;
            
            // Update Spotify display if section changed
            if (wasInGamesSection !== isInGamesSection) {
                spotifyManager.updatePlaybackInfo();
            }
        });

        // Add WeatherManager class
        class WeatherManager {
            constructor() {
                this.lastUpdate = 0;
                this.updateInterval = 10 * 60 * 1000; // 10 minutes
            }

            async getLocation() {
                if (!settings.useDeviceLocation) {
                    return {
                        latitude: settings.weatherLat,
                        longitude: settings.weatherLon
                    };
                }

                return new Promise((resolve, reject) => {
                    if (!navigator.geolocation) {
                        resolve({
                            latitude: settings.weatherLat,
                            longitude: settings.weatherLon
                        });
                        return;
                    }

                    navigator.geolocation.getCurrentPosition(
                        position => resolve(position.coords),
                        error => resolve({
                            latitude: settings.weatherLat,
                            longitude: settings.weatherLon
                        })
                    );
                });
            }

            async getWeather() {
                if (!settings.weatherApiKey) return null;
                
                try {
                    const coords = await this.getLocation();
                    const response = await fetch(
                        `https://api.openweathermap.org/data/2.5/weather?lat=${coords.latitude}&lon=${coords.longitude}&appid=${settings.weatherApiKey}&units=metric`
                    );

                    if (!response.ok) {
                        throw new Error('Weather API error');
                    }

                    return await response.json();
                } catch (error) {
                    console.error('Weather error:', error);
                    return null;
                }
            }

            async updateWeather() {
                const now = Date.now();
                if (now - this.lastUpdate < this.updateInterval) return;

                const weatherInfo = await this.getWeather();
                const weatherTemp = document.getElementById('weather-temp');
                const weatherInfo_el = document.getElementById('weather-info');

                if (weatherInfo) {
                    const temp = Math.round(weatherInfo.main.temp);
                    weatherTemp.textContent = `${temp}°C`;
                    weatherInfo_el.style.display = 'flex';
                    this.lastUpdate = now;
                } else {
                    weatherInfo_el.style.display = 'none';
                }
            }
        }

        // Initialize weather manager
        const weatherManager = new WeatherManager();
    </script>
</body>
</html>